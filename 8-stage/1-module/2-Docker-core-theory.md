第二部分 Docker核心原理

# 1 虚拟化技术

“云计算”，相信大家都会熟悉。作为信息科技发展的主流趋势，它频繁地出现在我们眼前。伴随它一起出现的，还有这些概念名词——OpenStack、Hypervisor、KVM、Docker、K8S...

这些名词概念，全部属于云计算技术领域地范畴。对于初学者来说，理解这些概念地具体含义并不是一件容易的事情。在介绍那些古怪名词之前，先简单介绍以下**计算机发展史**

![image-20220126135807126](assest/image-20220126135807126.png)

## 1.1 计算机发展史

上个世纪电脑被发明的时候，还没有网络，每个电脑（PC），就是一个单机。这台单机，包括CPU、内存、硬盘、显卡等硬件。用户在单机上，安装操作系统和应用软件，完成自己的工作。

后来有了网络（Network），单机与单机之间，可以交换信息，协同工作。

再后来，单机性能越来越强，就有了**服务器（Server）**。人们发现，可以把一些服务器集中起来，放在机房里，然后让用户通过网络，去访问和使用机房里的计算机资源。再再后来，小型网络变成了大型网络，就有了**互联网（Internet）**。小型机房变成大型机房，就有了**IDC（Internet Data Center，互联网数据中心）**。



## 1.2 云计算

云计算的道理是简单的，说白了，就是把计算机资源集中起来，放在网络上。但是，云计算的实现方式，就非常复杂了。

举个例子，如果你只是在公司小机房摆了一个服务器，开个 FTP 下载服务，然后用于几个同事之间的电影分享，当然是很简单的。

如果是 “双11” 的淘宝购物节，全球几十亿用户访问阿里巴巴的淘宝网站，单日几十 PB（1PB=1024TB=1024 x 1024GB）的访问量，每秒几百GB的流量...这个，就不是几根网线几台服务器能解决的了。

这时，需要设计一个超大容量、超高并发（同时访问）、超快速度、超强安全的云计算系统，才能满足业务平稳运行的要求。这才是云计算的复杂之处。

**第一层次**

是最底层的硬件资源，主要包括 CPU（计算资源），硬盘（存储资源），还有网卡（网络资源）等。

**第二层次**

要高级一些，我不打算直接使用CPU、硬盘、网卡，我希望你把操作系统（例如：windows、Linux）装好，把数据库软件装好，我再来使用。

**第三层次**

更高级一些，你不但要装好操作系统这些基本的，还要把具体的应用软件装好，例如 FTP 服务端软件、在线视频服务端软件等，我可以直接使用服务。



这三种层次，就是大家经常听到的 **IaaS**、**PaaS**、**SaaS**。

- **IaaS**：Infrastructure-as-a-Service（基础设施即服务），Infrastructure-as-a-Sevice。国内典型的就是阿里云，国际上的是 AWS
- **Paas**：Platform-as-a-Service（平台及服务），Platform-as-a-Service。国内典型的代表是新浪云，docker也属于PaaS
- **SaaS**：Software-as-a-Service（软件即服务），

目前主流的云计算服务提供商，例如亚马逊 AWS，阿里云、华为云、天翼云、腾讯云，说白了，都是为大家提供以上三个层次的云资源，你想要什么，它们就提供什么，你想要多少，它们就提供多少。

这样多样化多层次的云计算服务，阿里、华为们又是怎么提供的呢？

**于是，就有了各种软件和平台，负责对资源进行快速调用和集中管理**。



## 1.3 什么是虚拟化

如果要对物理资源进行管理，第一步，就是**“虚拟化”**。虚拟化是云计算的基础。简单来说，虚拟化就是在一套物理服务器上，运行多台“虚拟服务器”。这种虚拟服务器，也叫 **虚拟机（VM，Virtual Machine）**。

从表面上看，这些虚拟机都是独立的服务器，但实际上，它们共享物理服务器的 CPU、内存、硬盘、网卡等资源。通过模拟计算机的硬件，来实现在同一台计算机上同时运行不同操作系统的技术。常用的 vmwore、openstack、kvm 都是使用的虚拟化技术

- 物理机，通常称为“宿主机（Host）”
- 虚拟机，则称为“客户机（Guest）”

谁来完成物理资源虚拟化的工作？就是大名鼎鼎的 **Hypervisor**。

Hypervisor 也叫做 VMM（Virtual Machine Monitor，虚拟机监视器）。他不是一款具体的软件，而是一类软件的统称。Hypervisor 是一种运行在基础物理服务器硬件之上的软件层，可以虚拟化硬件资源，例如：cpu，硬盘、内存，声卡等资源，然后我们可以通过在虚拟化出来的资源之上安装操作系统。也就是所谓的虚拟机。通过 Hypervisor 我们可以创建不同的虚拟机，并且每个虚拟机都是分离的、独立的系统。这样操作，我们就可以在一台硬件服务器和本地操作系统之上虚拟化出来很多的服务器，供我们来部署应用程序。一台硬件服务器可以虚拟化多台服务器，让计算机资源得以充分利用。

Hypervisor 分为两大类：

- 第一类，hypervisor直接运行在物理机之上。虚拟机运行在 hypervisor之上。
- 第二类，物理机上安装正常的操作系统（例如Linux Windows），然后在正常操作系统上安装 hypervisor ，生成和管理虚拟机。像 **VMware**、**KVM**、**Xen**、**Virtual Box**，都属于Hypervisor。

人们在使用虚拟化一段时间后，发现它存在一些问题，不同的用户，有时候只是希望运行各自的一些简单程序，跑一个小程序，为了不互相影响，就要建立虚拟机。如果建虚拟机，显然浪费有点大，而且操作也会比较复杂，花费时间也会比较长。而且有的时候，想要迁移自己的服务程序，就要迁移整个虚拟机。显然，迁移过程也会很复杂。安装的虚拟机越多，消耗的资源对应越多。

环境兼容性问题，开发的时候环境运行正常，部署到虚拟机环境进行测试有可能发生错误。

有没有办法 **更灵活快捷**一些呢？有，这就引入了 **“容器（Container）”**。

## 1.4 什么是容器

基于硬件级虚拟化技术的缺点和不足，后续有发展出来另一种虚拟化技术，即操作系统级别的虚拟化技术。操作系统级虚拟化是运行在操作系统之上的虚拟化技术，它模拟的是运行在一个操作系统上的多个不同进程，并将其封闭在一个密闭的容器内，该技术也就被称之为容器化技术。

容器就是在隔离环境运行的一个进程，如果进程停止，容器就会销毁。隔离的环境拥有自己的系统文件，IP地址，主机名等。容器也就是虚拟化，但属于“轻量级”的虚拟化。它的目的和虚拟机一样，都是为了创建“隔离环境”。但是，它又和虚拟机有很大的不同 —— 虚拟机时操作系统级别的资源隔离，而容器本质上是**进程级的资源隔离**。

## 1.5 容器和虚拟化的区别

容器是将代码和环境打包在一起的一个集合，而虚拟机是在物理层面上分离出来一个操作系统；<br>多个容器可以运行在同一台硬件服务器上，并共享一个操作系统的内核资源。<br>多个虚拟机也可以运行在同一台服务器上，但是每个虚拟机都需要一个完整的操作系统。

## 1.6 虚拟化技术分类



### 1.6.1 CPU虚拟化

虚拟化在计算机方面同城是指计算元件在虚拟的基础上而不是真实的基础上运行。虚拟化技术可以扩大硬件的容量，简化软件的重新配置过程。简单说来，CPU的虚拟化技术就是单CPU模拟多CPU并行，允许一个平台同时运行多个操作系统，并且应用程序都可以在相互独立的空间运行而互不影响。从而显著提高计算机的工作效率。

### 1.6.2 网络虚拟化

网络虚拟化 是目前业界关于虚拟化细分领域界定最不明显，存在争议比较多的一个概念，微软眼中的“网络虚拟化”，是指虚拟专用网络（VPN）。VPN对网络连接的概念进行了抽象，允许远程用户访问组织的内部网络，就像物理上连接到该网络一样。网络虚拟化可以帮助保护 IT环境，防止来自 Internet 的威胁，同时使用户能够快速安全的访问应用程序和数据。

### 1.6.3 服务器虚拟化

与网路虚拟化不同，服务器虚拟化缺失虚拟化技术最早细分出来的子领域。根据 2006年 2月 Forrester Research 的调查，全球范围的企业对服务器虚拟化的认知率达到 75%，三分之一的企业已经在使用或者准备部署服务器虚拟化。这个产生于 20世纪60年代的技术日益显出其重要价值。由于服务器虚拟化发展时间长，应用钢钒，所以很多时候人们几乎把服务器虚拟化技术等同于虚拟化。

### 1.6.4 存储虚拟化

醉着信息业务的不断运行和发展，存储系统网络平台已经称为一个核心平台，大量高价值数据积淀下来，围绕这些数据的应用对平台的要求也越来越高，不光是在存储容量上，还包括数据访问性能、数据传输性能、数据管理能力、存储扩展能力等等多个方面。可以说，存储网络平台的综合性能的优劣，将直接影响到整个系统的正常运行。因为这个原因，虚拟化技术又一子领域——虚拟存储技术，营运而生。

### 1.6.5 应用虚拟化

前面的几种虚拟化技术，主要还是专注于对硬件平台资源的虚拟优化分配，随着IT应用的日益广泛，应用虚拟化作为虚拟化家族的明日之星登上了历史舞台。2006年7月由Forrester咨询公司在美国对各种不同的行业高层 IT 管理人员所做的一项研究显示，当今的机构现在将应用虚拟化当作是业务上的一个必由之路，而不是一个 IT 决策。据统计，全世界目前至少有超过 18万个机构在利用应用虚拟化技术进行集中 IT 管理、加强安全性和减少总体成本。



# 2 docker网络

当你开始大规模使用 docker时，你会发现需要了解很多关于网络的知识。docker作为目前最火的轻量级容器技术，有很多令人称道的功能，如 docker的镜像管理。然而，docker同样有着很多不完善的地方，网络方面就是Docker比较薄软的部分。因此，作为一名运维工程师有必要深入了解docker的网络知识。作为一名微服务开发工程师，简单了解 docker网络环节即可。首先介绍 Docker自身的 3 种 local 网络工作方式，然后介绍一些 docker 自定义网络模式。

docker 安装后会自动创建 3 种网络：

- bridge
- host
- none

```shell
docker network ls
```

![image-20220126154922453](assest/image-20220126154922453.png)

## 2.1 docker网络理论部分

docker使用 Linux 桥接网卡，在宿主机虚拟一个docker容器网桥（docker0），docker启动一个容器时会根据docker网桥的网段分配给容器一个IP地址，称为 Container-IP，同时docker网桥是每个容器的默认网关。因为在同一宿主机内的容器都接入同一个网桥，这样容器之间就能通过容器的Container-IP直接通信。

docker网桥是宿主机虚拟出来的，并不是真实存在的网络设备，外部网络是无法寻址到的，这也意味着玩不网络无法通过直接 Container-IP访问到容器。如果容器希望外部访问能够访问到，可以通过映射容器端口到宿主主机（端口映射），即docker run创建容器的时候通过 -p 或 -P 参数来启动，访问容器的时候就通过 **[宿主机IP]:[容器端口]**访问容器。

```shell
使用命令查看 docker 网络部分
docker info
```

## 2.2 网络模式

| Docker网络模式  | 配置                      | 说明                                                         |
| --------------- | ------------------------- | ------------------------------------------------------------ |
| host模式        | -net=host                 | 容器和宿主机共享 Network namespace。<br>容器将不会虚拟出自己的网卡，配置自己的IP等，<br>而是使用宿主机的IP和端口 |
| container模式   | -net=container:NAME_or_ID | 容器和另外一个容器共享Network Namespace<br>kubernetes中的pod就是多个容器共享一个 Network namespace<br>创建的容器不会创建自己的网卡，配置自己的IP，<br>而是和一个指定的容器共享IP、端口范围。 |
| none模式        | -net=none                 | 容器有独立的Network namespace，并没有对其及逆行任何网络配置，<br>如分配 veth pair 和网桥连接，配置IP等。<br>该模式关闭了容器的网络功能 |
| bridge模式      | -net=bridge               | （默认为该模式）。此模式会为每一个容器分配、设置IP等，<br>并将容器连接到一个docker0虚拟网桥，通过docker0网桥<br>以及Iptables nat表配置与宿主机通信。 |
| Macvlan network | 无                        | 容器具备Mac地址，使其显示为网络上的物理设备                  |
| Overlay         | 无                        | (覆盖网络)：利用VXLAN实现的bridge模式                        |

## 2.3 bridge模式

**默认的网络模式**。bridge模式下容器没有一个公有 ip，只有宿主机可以直接访问，外部主机是不可见的，但容器通过宿主机的NAT规则后可以访问外网。

**Bridge 桥接模式的实现步骤：**

- Docker Daemon 利用 veth pair 技术，在宿主机上创建两个虚拟网络接口设备，假设为 veth0 和 veth1。而 veth pair 技术的特性可以保证无论哪一个 veth 接收到网络报文，都将报文传输给另一方。
- Docker Daemon 将 veth0 附加到 Docker Daemon 创建的 docker0 网桥上。保证宿主机的网络报文可以发往 veth0；
- Docker Daemon 将 **veth1** 附加到 Docker Container 所属的 namespace 下，并被改名 eth0。如此一来，保证宿主机的网络报文若发往 veth0，则立即会被 eth0 接收，实现宿主机到 Docker Container 网络的联通性；同时，也保证 Docker Container 单独使用 eth0，**实现容器网络环境的隔离性**。

**Bridge桥接模式的缺陷：**

1. 最明显的是，该模式下 Docker Container 不具有一个公有 IP，即和宿主机的 eth0 不处于同一个网段。导致的结果是宿主机以外的世界不能直接和容器进行通信
2. 虽然 NAT 模式经过中间处理实现了这一点，但是 NAT 模式仍然存在问题与不便，如：容器均需要在宿主机上竞争端口，容器内部服务的访问者需要使用使用服务发现获知服务的外部端口等。
3. 另外 NAT 模式由于是在 三层网络上的实现手段，故肯定会影响网络的传输效率。

**注意：**

veth设备是成双成对出现的，一端是容器内部命名为 eth0，一端是加入到网桥并命名的 veth（通常命名为 veth），它们组成了一个数据传输通道，一端进一端出，veth设备连接了两个网络设备并实现了数据通信

## 2.4 host模式

相当于 VMware 中的 NAT 模式，与宿主机在同一个网络中，但没有独立IP地址。

如果启动容器的时候使用 host 模式，那么这个容器将不会获得一个独立的 Network Namespace，而是和宿主机共用一个Network Namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。但是，容器的其他方面，如文件系统、进程列表等还是和宿主机隔离的。

使用host模式的容器可以直接使用宿主机的IP地址与外界通信，容器内部的服务端口也可以直接使用宿主机的端口，不需要进行 NAT，host最大的优势就是网络性能比较好，但是docker host上已经使用的端口就不能再用了，网络隔离性不好。

host网络模式需要在容器创建时指定 -network=host

host模式是bridge桥接很好的补充。采用 host

## 2.5 Container网络模式

## 2.6 none模式

## 2.7 overlay 网络模式

## 2.8 macvlan 网络模式

# 3 docker数据卷

# 4 docker-compose

# 5 安装Dockerfile

# 6 部署微服务

# 7 idea集成docker