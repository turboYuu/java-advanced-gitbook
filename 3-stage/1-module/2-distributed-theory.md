第二部分 分布式理论与分布式架构设计理论

# 1 分布式架构设计

## 1.1 什么是分布式系统

分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。

通俗的理解，所谓分布式系统，就是一个业务拆分成多个子业务，分布在不同的服务器节点，共同构成的系统称为分布式系统。同一个分布式系统中的服务器节点在空间部署上是可以随意分布的，这些服务器可能放在不同的机柜中，也可能在不同的机房中，甚至分布在不同的城市。

![image-20211113135149753](assest/image-20211113135149753.png)



## 1.2 分布式与集群的区别

集群：多个服务器做同一个事情

![image-20211113135337266](assest/image-20211113135337266.png)

分布式：多个服务器做不同的事情

![image-20211113135408172](assest/image-20211113135408172.png)



## 1.3 分布式系统特性

1. 分布性

   空间中随机分布。这些计算机可以分布在不同的机房，不同的城市，甚至不同的国家。

2. 对等性

   分布式系统的计算机没有主从之分，组成分布式系统的所有节点都是对等的。

3. 并发性

   同一个分布式系统的多个节点，可能会并发地操作一些共享地资源，诸如数据库或分布式存储。

4. 缺乏全局时钟

   既然各个计算机之间是依赖于交换信息来进行相互通信，很难定义两件事件的先后顺序，缺乏全局时钟控制序列。

5. 故障总会发生

   组成分布式的计算机，都有可能在某一时刻突然间崩掉。分的计算机越多，可能崩掉一个的机率就越大。如果再考虑到设计程序时的异常故障，也会加大故障的概率。

6. 处理单点故障

   单点SPoF（Single Point Of Failure）：某个角色或者功能只有某一台计算机在支撑，在这台计算机上出现故障就是单点故障。

## 1.4 分布式系统面临的问题

1. 通信异常

   网络本身的不可靠性，因此每次网络通信豆瓣醉着网络不可用的风险（光纤、路由、DNS等硬件设备或系统的不可用），都会导致最终分布式系统无法顺利进行一次网络通信，另外，即使分布式系统个节点之间的网络通信能够正常执行，其延时也会大于单机操作，存在巨大的延时差别也会影响消息的收发过程，因此消息丢失和消息延迟变的非常普遍。

   ![image-20211113141327208](assest/image-20211113141327208.png)

2. 网络分区

   网络之间出现了网络不连通，但各个子网络的内部网络是正常的，从而导致整个系统的网络环境被切分成若干个孤立的区域，分布式系统就会出现局部小集群，在极端情况下，这些小集群会独立完成原本需要整个分布式系统才能完成的功能，包括数据的事务处理，这就对分布式一致性提出了非常大的挑战。

   ![image-20211113141654806](assest/image-20211113141654806.png)

3. 节点故障

   节点故障是分布式系统下一个比较常见的问题，指的是组成分布式系统的服务器节点出现宕机或僵死现象，根据经验来说，每个节点都有可能出现故障，并且经常发生。

   ![image-20211113141842768](assest/image-20211113141842768.png)

4. 三态

   分布式系统每一次请求与响应存在特有的三态概念，即成功、失败 和 超时。

   ![image-20211113141947782](assest/image-20211113141947782.png)

5. 重发

   分布式系统在发生调用的时候可能出现 失败、超时 的情况。这个时候需要重新发起调用。

   ![image-20211113142051354](assest/image-20211113142051354.png)

6. 幂等

   一次和多次请求某一个资源对于资源本身应该具有相同的结果（网络超时等问题除外）。也就是说，其任意多次执行对资源本身所产生的影响与一次执行的影响相同。

   - 场景1

     ![image-20211113142340559](assest/image-20211113142340559.png)

   - 场景2

     ![image-20211113142428248](assest/image-20211113142428248.png)

   - 场景3

     ![image-20211113142447362](assest/image-20211113142447362.png)

# 2 分布式理论

## 2.1 数据一致性

### 2.1.1 什么是分布式数据一致性

分布式数据一致性，指的是数据在多副本中存储时，各副本中的数据是一致的。

![image-20211113142716140](assest/image-20211113142716140.png)

### 2.1.2 副本一致性

分布式系统中，数据往往会有多个副本。多个副本就需要保证数据的一致性。这就带来了同步的问题，因为网络延迟等因素，我们几乎没有办法保证可以同时更新所有机器当中的包括备份的所有数据，因此就会有数据不一致的情况。

![image-20211113143324920](assest/image-20211113143324920.png)

总的来说，我们无法找到一种能够满足分布式系统中数据一致性解决方案。因此，如何保证数据的一致性，同时又不影响系统运行的性能，是每一个分布式系统都需要重点考虑和权衡的。于是，一致性级别由此诞生。



### 2.1.3 一致性分类

1. 强一致性

   这种一致性级别是最符合用户直觉的，它要求系统写入什么，读出来的也会是什么，用户体验好，但实现起来往往对系统的性能影响大。且强一致性很难实现。

2. 弱一致性

   这种一致性级别约束了系统在写入成功后，不承诺立即可以读到写入的值，也不承诺多久之后数据能够达到一致，但会尽可能地保证到某个时间级别（比如秒级别）后，数据能够达到一致状态。

3. 最终一致性

   **最终一致性是弱一致性的一种**，它无法保证数据更新后，所有后续的访问都能看到最新数值，而是需要一个时间，在这个时间之后可以保证这一点（就是在一段时间后，节点间的数据会最终达到一致状态），而在这个时间内，数据也许是不一致的，这个系统无法保证强一致性的时间片段被称为【不一致窗口】。不一致窗口的时间长短取决于很多因素，比如备份数据的个数、网络传输延迟速度、系统负载等。

   最终一致性在实际应用中又有多种变种：

   - 因果一致性

     如果进程A通知进程B，它已经更新了一个数据项，那么进程B的后续访问将返回更新后的值。与进程A无因果关系的进程C的访问遵守一般的最终一致性规则。

     ![image-20211113145629032](assest/image-20211113145629032.png)

     

   - 读已知所写一致性

     当进程A自己更新一个数据项之后，它总是访问到更新过的值，绝不会看到旧值。这是因果一致性模型的一个特例。

     ![image-20211113145824822](assest/image-20211113145824822.png)

   - 会话一致性

     它把访问存储系统的进程放到会话的上下文中。只要会话还存在，系统就保证“读已知所写”一致性。如果由于某些失败情形令会话终止，就要建立新的会话，而且系统保证不会延续到新的会话。

     ![image-20211113150413819](assest/image-20211113150413819.png)

     

   - 单调一致性

     如果一个进程已经读取到一个特定值，那么该进程不会读取到该值以前的任何值。

     ![image-20211113150514883](assest/image-20211113150514883.png)

   - 单调写一致性

     系统保证对同一个进程的写操作串行化。

     ![image-20211113150548654](assest/image-20211113150548654.png)

4. 一致性模型图

   ![image-20211113150652213](assest/image-20211113150652213.png)

## 2.2 CAP定理

### 2.2.1 CAP定理介绍

CAP定理（CAP theorem），又被称为布鲁尔定理（Brewer's theorem），它之处对于一个分布式计算系统来说，不可能同时满足以下三点

| 选项                  | 具体意义                               |
| --------------------- | -------------------------------------- |
| 一致性（Consistency） | 所有节点访问是都是同一份最新的数据副本 |
|                       |                                        |
|                       |                                        |



### 2.2.2 CAP三者不可能同时满足论证

### 2.2.3 CAP三者如何权衡

## 2.3 BASE理论

# 3 分布式一致性协议

# 4 分布式系统设计策略

# 5 分布式架构服务调用

# 6 分布式服务治理

# 7 架构设计基本原则

