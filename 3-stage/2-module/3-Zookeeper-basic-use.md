> 第三部分 Zookeeper基本使用

# 1 Zookeeper系统模型

在 Zookeeper 中，数据信息被保存在一个个数据节点上，这些节点被称为 znode。ZNode 是 Zookeeper 中最小数据单位，在 ZNode 下面又可以再挂 ZNode，这样一层层下去就形成了一个层次化命名空间 ZNode 树，我们称为 ZNode Tree，它采用了类似文件系统的层级树状结构进行管理。见下图：

![image-20220712184208232](assest/image-20220712184208232.png)

在 Zookeeper 中，每一个数据节点都是一个 ZNode，上图根目录下有两个，分别是：znode1 和 znode2，其中 znode1 下面又有两个子节点，所有 ZNode 按层次化进行组织，形成这么一棵树，ZNode 的节点路径标识方式 和 Unix 文件系统路径非常相似，都是由一些列使用斜杠（/）进行分割的路径表示，开发人员可以向这个节点写入数据，也可以在这个节点下面创建子节点。

## 1.1 ZNode 的类型

刚刚已经了解到，Zookeeper 的 znode tree 是由一系列数据节点组成的，那接下来，就对数据节点做详细讲解。

Zookeeper 节点类型可以分为三大类：

1. 持久性节点（Persistent）
2. 临时性节点（Ephemeral）
3. 顺序性节点（Sequential）

在开发中创建节点的时候通过组合可以生成以下四种节点类型：持久节点、持久顺序节点、临时节点、临时顺序节点。不同类型的节点则会有不同的生命周期。

**持久节点**：是Zookeeper中最常见的一种节点类型，所谓持久节点，就是指节点被创建后会一致存在服务器，直到删除操作主动清除。

**持久顺序节点**：就是有顺序的持久节点，节点特性 和 持久节点是一样的，只是额外特性表现在顺序上。顺序特性实质是在创建节点的时候，会在节点后面加上一个数字后缀，来表示其顺序。

**临时节点**：就是会被自动清理掉的节点，它的生命周期和客户端会话绑在一起，客户端会话结束，节点会被删除掉。与持久性节点不同的是：**临时节点不能创建子节点**。

**临时顺序节点**：就是有顺序的临时节点，和持久顺序节点相同，在其创建的时候会在名字后面加上数字后缀。



**事务ID**

首先，先了解，事务是对物理和抽象的应用状态上的操作集合。往往在现在的概念中，侠义上的事务通常指的是数据库事务，一般包含了一系列对数据库有序的读写操作，这些数据库事务具有所谓的 ACID 特性，即原子性（Atomic）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。

而在 Zookeeper 中，事务是指能够改变 Zookeeper 服务器状态的操作，我们也称之为事务操作或更新操作，一般包括数据节点创建和删除、数据节点内容更新等操作。对于每一个事务请求，Zookeeper 都会为其分配一个全局唯一的事务 ID，用 ZXID 来表示，通常是一个 64 位的数字。每一个 ZXID 对应一次更新操作，从这些 ZXID 中可以间接地识别出 Zookeeper 处理这些更新操作请求的全局顺序。

## 1.2 ZNode 的状态信息

![image-20220713102423068](assest/image-20220713102423068.png)

整个 ZNode 节点内容包括两部分：节点数据内容和节点状态信息。图中quota是数据内容，其他的属性状态信息。那么这些状态信息都有什么含义呢？

```bash
cZxid 就是 Create ZXID, 表示节点被创建时的事务ID。
ctime 就是 Create Time, 表示节点创建时间。
mZxid 就是 Modified ZXID, 表示节点最后一次被修改时的事务ID。
mtime 就是 Modified Time, 表示节点最后一次被修改的时间。
pZxid 表示该节点的子节点列表最后一次被修改时的事务ID, 只有子节点列表变更才会更新 pZxid, 子节点内容变更不会更新。
cversion 表示子节点的版本号。
dataVersion 表示内容版本号。
aclVersion 表示acl版本
ephemeralOwner 表示创建该临时节点时的会话 sessionID, 如果是持久性节点那么值为 0 
dataLength 表示数据长度。
numChildren 表示直系子节点数。
```



## 1.3 Watcher -- 数据变更通知

Zookeeper 使用 Watcher 机制实现分布式数据的发布/订阅 功能

一个典型的发布/订阅 模型系统定义了一种 一对多的订阅关系，能够让多个订阅者同时监听某一个主题对象，当这个主题对象自身状态变化时，会通知所有订阅者，使它们能够做出相应的处理。

在 Zookeeper 中，引入了 Watcher 机制来实现这种分布式的通知功能。Zookeeper 允许客户端向服务器端注册一个 Watcher 监听，当服务端的一些指定事件触发了这个 Watcher，那么就会向指定客户端发送一个事件通知来实现分布式的通知功能。

整个 Watcher 注册与通知过程如图所示：

![image-20220713110113325](assest/image-20220713110113325.png)

Zookeeper 的 Watcher 机制主要包括 **客户端线程**、客户端WatcherManager、Zookeeper服务器 三部分。

具体工作流程为：客户端在向 Zookeeper 服务器注册的同时，会将 Watcher 对象存储在客户端的 WatcherManager 中。当 Zookeeper 服务器触发 Watcher 事件后，会向客户端发送通知，客户端线程从 WatcherManager 中取出对应的 Watcher 对象来执行回调逻辑。

## 1.4 ACL -- 保障数据的安全

Zookeeper 作为一个分布式协调框架，其内部存储了分布式系统运行时状态的元数据，这些元数据会直接影响基于 Zookeeper 进行构造的分布式系统的运行状态。因此，如何保障系统中数据的安全，从而避免因误操作所带来的数据随意变更而导致的数据库异常，显得十分重要，在Zookeeper中，提供了一套完善的 ACL（Access Control List）权限控制机制来保障数据的安全。

可以从三个方面来理解 ACL 机制：**权限模式（Scheme）**、**授权对象（ID）**、**权限（Permission）**，通常使用 "**scheme​ : id : ​permission**" 来标识一个有效的 ACL 信息。

### 1.4.1 权限模式（Scheme）

权限模式 用来确定权限验证过程中使用的检验策略，有如下 4 种模式：

1. IP

   IP 模式就是通过 IP 地址粒度来进行权限控制，如 "ip:192.168.0.110" 表示权限控制针对该 IP 地址，同时IP模式可以支持按照网段方式进行配置，如 "ip:192.168.0.1/24" 表示针对 192.168.0.* 这个网段进行权限控制。

2. Digest

   Digest 是最常用的权限控制模式，要更符合我们对权限控制的认识，其使用 "username:password" 形式的权限标识来进行权限配置，便于区分不同应用来进行权限控制。

   当我们通过 "username:password" 形式配置的权限标识后，Zookeeper 会先后对其进行 SHA-1 加密和 BASE64 编码。

   

3. World

4. Super

### 1.4.2 授权对象（ID）

### 1.4.3 权限（Permission）

# 2 Zookeeper 命令行操作

# 3 Zookeeper的API使用

# 4 Zookeeper 开源客户端