> 第五部分 Zookeeper深入进阶

# 1 ZAB 协议

## 1.1 概念

zookeeper 并没有完全采用 paxos 算法，而是使用了一种称为 Zookeeper Atomic Broadcast（ZAB，Zookeeper 原子消息广播协议）的协议作为其数据一致性的核心算法。

ZAB 协议并不像 Paxos 算法那样是一种通用的分布式一致性算法，它是一种特别为 zookeeper 专门设计的一种**支持崩溃恢复的原子广播协议**

在 Zookeeper 中，主要就是依赖 ZAB 协议来实现分布式数据的一致性，基于该协议，Zookeeper 实现了一种主备模式的系统架构来保持集群中各副本之间数据的一致性，表现形式就是 使用一个单一的主进程来接收并处理客户端的所有事务请求，并采用ZAB 的原子广播协议，将服务器数据的状态变更以事务 Proposal 的形式广播到所有的副本进程中，ZAB 协议的主备模型架构保证了同一时刻集群中只能够有一个主进程来广播服务器的状态变更，因此能够很好的处理客户端大量的并发请求。但是，也要考虑到主进程在任何时候都有可能出现崩溃退出 或 重启现象，因此，ZAB 协议还需要做到当前主进程出现上述异常情况的时候，依旧能正常工作。



## 1.2 ZAB 核心

ZAB 协议的核心是定义了对于那些会改变 Zookeeper 服务器数据状态的事务请求的处理方式。

> 即：所有的事务请求必须由一个全局唯一的服务器来协调处理，这样的服务器被称为 Leader 服务器，余下的服务器则称为 Follower 服务器。
>
> Leader 服务器负责将一个客户端事务请求转化为一个事务 Proposal （提议），并将该 Proposal 分发给集群中所有的 Follower 服务器，之后 Leader 服务器需要等待所有 Follower 服务器的反馈，一旦超过半数的 Follower 服务器进行了正确的反馈后，那么 Leader 就会再次向所有的 Follower 服务器分发 Commit 消息，要求其将前一个 Proposal 进行提交。

![image-20220719172818430](assest/image-20220719172818430.png)



## 1.3 ZAB 协议介绍

ZAB 协议包括两种基本模式：**崩溃恢复** 和 **消息广播**

进入崩溃恢复模式：

当整个服务框架启过程中，或者是 Leader 服务器出现网络中断、崩溃退出 或 重启等异常情况时，ZAB 协议就会进入崩溃恢复模式，同时选举产生新的 Leader 服务器。当选举产生了新的 Leader 服务器，同时集群中已经有过半的机器与该 Leader 服务器完成了状态同步之后，ZAB 协议就会退出恢复模式，其中，所谓的状态同步 就是指数据同步，用来保证集群中过半的机器能够和 Leader 服务器的数据状态保持一致。

进入消息广播模式：

当集群中已经有过半的Follower服务器完成了 和 Leader 服务器的状态同步，那么整个服务框架就可以进入**消息广播模式**，当一台同样遵守 ZAB 协议的服务器启动后加入到集群中，如果此时集群中已经存在一个 Leader 服务器在负责进行消息广播，那么加入的服务器就会自觉地进入**数据恢复模式**：**找到Leader所在的服务器，并与其进行数据同步，然后一起参与到消息广播流程中去**。Zookeeper 只允许唯一的一个Leader服务器来进行事务请求的处理，Leader服务器在接收到客户端的事务请求后，会生成对应的事务提议并发起一轮广播，而如果集群中的其他机器收到客户都的事务请求后，那么这些非 Leader 服务器会首先将这个事务转发给 Leader 服务器。

接下来重点讲解 ZAB 协议的消息广播过程和崩溃恢复过程。

### 1.3.1 消息广播

ZAB 协议的消息广播过程使用原子广播协议，类似于一个二阶段提交过程，针对客户端的事务请求，Leader 服务器会为其生成对应的事务 Proposal，并将其发送给集群中其余所有的机器，然后再分别收集各自的选票，最后进行事务提交。

![image-20220719172818430](assest/image-20220719172818430.png)

在 ZAB 的二阶段提交过程中，移除了中断逻辑，所有的 Follower的服务要么正常反馈 Leader 提出的事务 Proposal，要么就抛弃 Leader 服务器。同时，ZAB 协议将二阶段提交中的中断逻辑移除意味着我们可以在过半的 Follower服务器已经反馈 Ack 之后就开始提交事务 Proposal 了，而不需要等待集群中所有的 Follower 服务器都反馈响应。

但是，在这种简化的二阶段提交模型下，无法处理因 Leader 服务器崩溃退出而带来的数据不一致问题，因此 ZAB 采用了崩溃恢复模式来解决问题。另外，整个消息广播协议是基于具有 FIFO 特性的 TCP 协议来进行网络通信的，因此 能够很容易保证消息广播过程中消息接收与发送的顺序性。

在整个消息广播过程中，Leader 服务器会为每个请求生成对应的 Proposal 来进行广播，并且在广播事务 Proposal 之前，Leader 服务器会首先为这个事务 Proposal 分配一个全局单调递增的唯一 ID，称为之 事务ID（**Zxid**），由于 ZAB 协议需要保证每个消息严格的因果关系，因此必须将每个事务 Proposal 按照其 Zxid 的先后顺序进行排序和处理。

具体的过程：在消息广播过程中，Leader 服务器会为每一个 Follower 服务器都各自分配一个单独的队列，然后将需要广播的事务 Proposal 一次放入这些队列中，并且根据 FIFO 策略进行消息发送。每一个 Follower 服务器在接收到这个事务 Proposal 之后，都会首先以事务日志的形式写入到本地磁盘中，并且在成功写入后反馈给 Leader 服务器一个 Ack 响应。当 Leader 服务器接收到超过半数 Follower 的 Ack 响应后，就会广播一个 Commit 消息给所有的 Follower 服务器以通知其进行事务提交。同时 Leader 自身也会完成对事务的提交，而每一个 Follower 服务器在接收到 Commit 消息后，也会完成对事务的提交。

### 1.3.2 崩溃恢复



## 1.4 运行时状态分析

## 1.5 ZAB 与 Paxos 的联系和区别

# 2 服务器角色

## 2.1 Leader

## 2.2 Follower

## 2.3 Observer

# 3 服务器启动

## 3.1 服务端整体架构图

## 3.2 单机版服务器启动

## 3.3 集群服务器启动

# 4 Leader选举

## 4.1 服务器启动时期的 Leader 选举

## 4.2 服务器运行时期的 Leader 选举