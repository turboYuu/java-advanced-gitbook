> 第五部分 Zookeeper深入进阶

# 1 ZAB 协议

## 1.1 概念

zookeeper 并没有完全采用 paxos 算法，而是使用了一种称为 Zookeeper Atomic Broadcast（ZAB，Zookeeper 原子消息广播协议）的协议作为其数据一致性的核心算法。

ZAB 协议并不像 Paxos 算法那样是一种通用的分布式一致性算法，它是一种特别为 zookeeper 专门设计的一种**支持崩溃恢复的原子广播协议**

在 Zookeeper 中，主要就是依赖 ZAB 协议来实现分布式数据的一致性，基于该协议，Zookeeper 实现了一种主备模式的系统架构来保持集群中各副本之间数据的一致性，表现形式就是 使用一个单一的主进程来接收并处理客户端的所有事务请求，并采用ZAB 的原子广播协议，将服务器数据的状态变更以事务 Proposal 的形式广播到所有的副本进程中，ZAB 协议的主备模型架构保证了同一时刻集群中只能够有一个主进程来广播服务器的状态变更，因此能够很好的处理客户端大量的并发请求。但是，也要考虑到主进程在任何时候都有可能出现崩溃退出 或 重启现象，因此，ZAB 协议还需要做到当前主进程出现上述异常情况的时候，依旧能正常工作。



## 1.2 ZAB 核心

ZAB 协议的核心是定义了对于那些会改变 Zookeeper 服务器数据状态的事务请求的处理方式。

> 即：所有的事务请求必须由一个全局唯一的服务器来协调处理，这样的服务器被称为 Leader 服务器，余下的服务器则称为 Follower 服务器。
>
> Leader 服务器负责将一个客户端事务请求转化为一个事务 Proposal （提议），并将该 Proposal 分发给集群中所有的 Follower 服务器，之后 Leader 服务器需要等待所有 Follower 服务器的反馈，一旦超过半数的 Follower 服务器进行了正确的反馈后，那么 Leader 就会再次向所有的 Follower 服务器分发 Commit 消息，要求其将前一个 Proposal 进行提交。

![image-20220719172818430](assest/image-20220719172818430.png)



## 1.3 ZAB 协议介绍

ZAB 协议包括两种基本模式：**崩溃恢复** 和 **消息广播**

进入崩溃恢复模式：

当整个服务框架启过程中，或者是 Leader 服务器出现网络中断、崩溃退出 或 重启等异常情况时，ZAB 协议就会进入崩溃恢复模式，同时选举产生新的 Leader 服务器。当选举产生了新的 Leader 服务器，同时集群中已经有过半的机器与该 Leader 服务器完成了状态同步之后，ZAB 协议就会退出恢复模式，其中，所谓的状态同步 就是指数据同步，用来保证集群中过半的机器能够和 Leader 服务器的数据状态保持一致

## 1.4 运行时状态分析

## 1.5 ZAB 与 Paxos 的联系和区别

# 2 服务器角色

## 2.1 Leader

## 2.2 Follower

## 2.3 Observer

# 3 服务器启动

## 3.1 服务端整体架构图

## 3.2 单机版服务器启动

## 3.3 集群服务器启动

# 4 Leader选举

## 4.1 服务器启动时期的 Leader 选举

## 4.2 服务器运行时期的 Leader 选举