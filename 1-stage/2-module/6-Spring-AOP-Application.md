第六部分 Spring AOP 应用

> AOP本质：在不改变原有业务逻辑的情况下增强横切逻辑，横切逻辑代码往往是权限检验，日子代码，事务控制代码，性能监控代码。

# 1 AOP 相关术语

## 1.1 业务主线

在讲解AOP之前，我们先看一下下面这两张图，它们就是该部分案例需求的扩展（针对这些扩展的需求，我们只进行分析，在此基础上）

![image-20220402181130552](assest/image-20220402181130552.png)

上图描述的就是未采用 AOP 思想设计的程序，当我们红色框中圈定的方法时，会带来大量的重复劳动。程序中充斥着大量的重复代码，使我们程序的独立性很差。而下图中是采用了AOP思想设计的程序，它把红框部分的代码抽取出来的同时，运用动态代理技术，在运行期对需要使用的业务逻辑方法进行增强。

![image-20220402183954632](assest/image-20220402183954632.png)

## 1.2 AOP 术语

| 名称              | 解释                                                         |
| ----------------- | ------------------------------------------------------------ |
| JoinPoint(连接点) | 指的是那些**可以**用于把增强代码加入到业务主线中的点，<br>那么由上图中我们可以看出，这些点指的就是方法。<br>在方法执行的前后通过动态代理技术加入增强的代码。<br>在Spring框架AOP思想的技术实现中，也只支持方法类型的连接点。 |
| Pointcut(切入点)  | 指的是那些**已经**把增强代码写入到业务主线进来之后的连接点。<br>由上图中，我们看出表现层 `register` 方法只是连接点，<br>因为判断访问权限的功能并没有对其增强。 |
| Advice(通知/增强) | 指的是切面类中用于提供增强功能的方法。并且不同的方法增强的时机是不一样的。<br>比如，开启事务肯定要在业务方法执行之前执行；<br>提交事务要在业务方法正常执行之后执行，而回滚事务要在业务方法执行产生异常之后执行等等。<br>那么这些就是通知的类型。其分类有：**前置通知 后置通知 异常通知 最终通知 环绕通知** |
| Target(目标)      | 指的是代理的目标对象。即被代理对象                           |
| Proxy(代理)       | 指的是一个类被 AOP 织入增强后，产生的代理类。即代理对象      |
| Weaving(织入)     | 指的是把增强应用到目标对象来创建新的代理对象的过程。<br>Spring 采用动态代理织入，而 AspectJ 采用编译期织入和类装载期织入 |
| Aspect(切面)      | 指的是增强的代码所关注的方面，把这些相关的增强代码定义到一个类中，这个类就是切面类。<br>例如，事务切面。它里面定义的方法就是和事务相关的，像开启事务，提交事务，回滚事务等等，<br>不会定义其他与事务无关的方法。前面案例中 `TransactionManager` 就是一个切面。 |

1. 连接点：方法开始时，结束时，正常运行完毕时、方法异常时等这些特殊的时机点，我们称之为连接点，项目中每个方法都有连接点，连接点是一种**候选点**。

2. 切入点：指 AOP 思想要影响的具体方法是哪些，描述感兴趣的方法

3. Advice增强：

   第一个层次：指的是横切逻辑

   第二个层次：方位点（在某一些连接点上加入横切逻辑，那么这些连接点就叫做方位点，描述的是具体的特殊时机）

   Aspect 切面：切面是对上述概念的一个综合

   Aspect切面 = 切入点 + 增强

   ​					 = 切入点（锁定方法）+ 方位点（锁定方法中的特殊时机）+ 横切逻辑 

# 2 Spring 中AOP的代理选择

Spring 实现 AOP 思想使用的是动态代理技术

默认情况下，Spring 会根据被代理对象是否实现接口来选择使用 jdk 还是 cglib。当被代理对象没有实现任何接口时，Spring 会选择 cglib；当被代理对象实现了接口，Spring 会选择 jdk 官方的代理技术。不过可以通过配置的方式，让 Spring 强制使用 cglib。

# 3 Spring中AOP的配置方式

在 Spring 的 AOP 配置中，也和 IoC 配置一样，支持三类配置方式：

1. 使用 xml 配置
2. 使用 xml + 注解组合配置
3. 使用纯注解配置

# 4 Spring中AOP实现

需求：横切逻辑代码是打印日志，希望把打印日志的逻辑织入到目标方法的特定位置（service 层 transfer 方法）。

## 4.1 xml 模式

Spring 是模块化开发的框架，使用 aop 就引入 aop 的 jar

- pom.xml

  ```xml
  
  ```

- AOP 核心配置

  ```xml
  
  ```

### 4.1.1 关于切入点表达式

### 4.1.2 改变代理方式的配置

### 4.1.3 五种通知类型

#### 4.1.3.1 前置通知

#### 4.1.3.2 后置通知

#### 4.1.3.3 异常通知

#### 4.1.3.4 最终通知

#### 4.1.3.5 环绕通知

## 4.2 xml + 注解模式

## 4.3 注解模式

# 5 Spring 声明式事务支持

## 5.1 事务回顾

### 5.1.1 事务的概念

### 5.1.2 事务的四大特性

### 5.1.3 事务的隔离级别

### 5.1.4 事务的传播级别

## 5.2 Spring 中事务的 API

## 5.3 Spring 声明式事务配置